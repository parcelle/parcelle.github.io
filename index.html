<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parcelle</title>
  <meta name="description" content="Tirage aléatoire d'une parcelle de un kilomètre carré en France métropolitaine."/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#FAF7F3;
      --fg:#2B1E1A;
      --muted:#6b5f59;
      --accent:#1b271a;
      --accent-2:#d7f1d4;
      --danger:#ff6a8c;
      --border:rgba(30,22,18,0.12);
      --panel-bg:#ffffff;
      --panel-elev:0 4px 12px rgba(0,0,0,.08);
      --square-color:#1b271a;
    }
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,sans-serif;}
    #map{position:absolute;inset:0;z-index:1;}
    .hud{position:absolute;inset:0;pointer-events:none;}

    /* Minimal control panel — aligned & flush */
    .panel{
      position:absolute;right:16px;bottom:16px;
      display:flex;flex-direction:column;gap:10px;min-width:260px;
      background:var(--panel-bg);border:1px solid var(--border);border-radius:14px;
      padding:12px;box-shadow:var(--panel-elev);pointer-events:auto;
      box-sizing:border-box;
    }
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-start;width:100%}
    .btn{
      appearance:none;border:1px solid var(--border);border-radius:12px;
      padding:10px 14px;font-weight:600;cursor:pointer;
      transition:background .15s ease, transform .08s ease, border-color .15s ease;
      display:inline-flex;align-items:center;gap:8px;background:#fff;
    }
    .btn:hover{background:#f6f6f6}
    .btn:active{transform:translateY(1px)}
    .primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .primary:hover{background:#162114}
    .ghost{background:transparent}

    /* Small, subtle status in top-right */
    .status-corner{
      position:absolute;top:10px;right:12px;pointer-events:none;
      font-size:12px;font-weight:600;color:var(--fg);opacity:.35;letter-spacing:.2px;
      user-select:none;
    }

    /* Tooltip removed; using text label instead */
    .pop-label{
      font-weight:700;font-size:14px;line-height:1;
      color:var(--square-color);
      text-shadow:none;
      white-space:nowrap;
      pointer-events:none;
    }

    /* Mask pane above tiles, below HUD */
    .leaflet-pane.mask-pane { z-index: 600; pointer-events:none; }

    /* Grid look */
    .leaflet-tile{image-rendering:auto}
  </style>
</head>
<body>
  <div id="app">
    <div id="map" aria-label="Map of metropolitan France"></div>

    <!-- Subtle status in the corner -->
    <div id="statusCorner" class="status-corner" aria-hidden="true">OK</div>

    <div class="hud" aria-hidden="true">
      <div class="panel" id="panel">
        <div class="row">
          <button id="pickBtn" class="btn primary">Pick a random place</button>
          <button id="resetBtn" class="btn ghost">Reset</button>
        </div>
      </div>
    </div>
  </div>

<script>
// --- Constants & helpers ----------------------------------------------------
const FR_BOUNDS = L.latLngBounds([ [41.0,-5.8], [51.7,9.9] ]);
const START_VIEW = [46.7, 2.5];
const START_ZOOM = 5.3;
const csvUrl = 'data/france_1km_pop_centroids.csv';

// Subtle status in the corner
function setStatus(msg){
  const el = document.getElementById('statusCorner');
  if(el) el.textContent = msg;
}

// Weighted reservoir sampling
class WeightedSampler {
  constructor(){ this.bestKey = -Infinity; this.bestItem = null; }
  consider(item, weight){
    if(!(weight>0)) return;
    const u = Math.random();
    const key = Math.pow(u, 1/weight);
    if(key > this.bestKey){ this.bestKey = key; this.bestItem = item; }
  }
}

// 1 km square centered on [lon,lat]
function buildSquarePolygon(lon, lat){
  const center = [lon, lat];
  const d = Math.SQRT1_2; // ~0.7071 km
  const bearings = [45,135,225,315,45];
  const coords = bearings.map(b => turf.destination(center, d, b, {units:'kilometers'}).geometry.coordinates);
  return turf.polygon([coords]);
}

// Screen-space grid
const GridLayer = L.GridLayer.extend({
  createTile: function(coords){
    const tile = L.DomUtil.create('canvas', 'leaflet-tile');
    const size = this.getTileSize();
    tile.width = size.x; tile.height = size.y;
    const ctx = tile.getContext('2d');

    const map = this._map;
    const zoom = this._tileZoom;

    const nwPoint = coords.multiplyBy(size.x);
    const sePoint = nwPoint.add([size.x, size.y]);
    const nw = map.unproject(nwPoint, zoom);
    const se = map.unproject(sePoint, zoom);
    const lat = (nw.lat + se.lat)/2;

    const mpp = 156543.03392 * Math.cos(lat * Math.PI/180) / Math.pow(2, zoom);
    let stepKm = 1;
    let pxStep = (stepKm * 1000) / mpp;
    while (pxStep < 16) { stepKm *= 2; pxStep = (stepKm * 1000) / mpp; if (stepKm > 128) break; }

    const startX = (pxStep - (nwPoint.x % pxStep)) % pxStep;
    const startY = (pxStep - (nwPoint.y % pxStep)) % pxStep;

    ctx.strokeStyle = 'rgba(0,0,0,0.10)';
    ctx.lineWidth = 1;
    for(let x = startX; x <= size.x; x += pxStep){ ctx.beginPath(); ctx.moveTo(x + .5, 0); ctx.lineTo(x + .5, size.y); ctx.stroke(); }
    for(let y = startY; y <= size.y; y += pxStep){ ctx.beginPath(); ctx.moveTo(0, y + .5); ctx.lineTo(size.x, y + .5); ctx.stroke(); }
    return tile;
  }
});

// Demo data if CSV missing
const SAMPLE = [
  { lon: 2.3522, lat: 48.8566, pop: 2140000 },
  { lon: 5.3698, lat: 43.2965, pop: 870000  },
  { lon: 4.8357, lat: 45.7640, pop: 515000  },
  { lon: -1.5536, lat: 47.2184, pop: 314000 },
  { lon: 7.2619, lat: 43.7102, pop: 342000  },
];

// --- App state --------------------------------------------------------------
let map, base, gridLayer;
let usingSample = false;

// Layers for selection/mask/label
const maskPaneName = 'mask-pane';
let maskLayer = null;
let squareDashLayer = null;
let squareBorderLayer = null;
let popLabelMarker = null;

function initMap(){
  map = L.map('map', { zoomControl: false, attributionControl: true, minZoom: 4, maxZoom: 18, preferCanvas: true })
          .setView(START_VIEW, START_ZOOM);

  L.control.zoom({position:'bottomleft'}).addTo(map);

  base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
  }).addTo(map);

  gridLayer = new GridLayer().addTo(map);

  map.createPane(maskPaneName);
  const pane = map.getPane(maskPaneName);
  if(pane){ pane.classList.add('mask-pane'); }

  map.fitBounds(FR_BOUNDS, { paddingTopLeft:[20,60], paddingBottomRight:[20,120]});

  setStatus('OK');
}

// Parsing helpers
function parseNumber(v){
  if (typeof v === 'number') return v;
  if (typeof v === 'string'){
    const n = Number(v.trim().replace(',', '.'));
    return Number.isFinite(n) ? n : NaN;
  }
  return NaN;
}
function getField(obj, names){
  for(const n of names){
    const k = Object.keys(obj).find(key => key.toLowerCase().trim() === n);
    if(k != null) return obj[k];
  }
  return undefined;
}

function pickRandomSquare(){
  clearSelection();
  setStatus('Sampling…');

  const sampler = new WeightedSampler();
  let processed = 0;
  let fellBack = false;

  const watchdog = setTimeout(() => {
    if(!fellBack){
      fellBack = true;
      console.warn('CSV sampling watchdog — using sample data');
      usingSample = true;
      finishSampling();
    }
  }, 20000);

  function considerRow(r){
    const lonRaw = getField(r, ['lon','lng','long','longitude','x']);
    const latRaw = getField(r, ['lat','latitude','y']);
    const popRaw = getField(r, ['pop','population','count','n','p']);
    const lon = parseNumber(lonRaw);
    const lat = parseNumber(latRaw);
    const pop = parseNumber(popRaw);
    if(Number.isFinite(lon) && Number.isFinite(lat) && Number.isFinite(pop)){
      if (lat >= 39 && lat <= 53.5 && lon >= -7.5 && lon <= 12){
        const w = Math.log(1 + Math.max(0, pop));
        sampler.consider({lon,lat,pop}, w);
      }
    }
  }

  function onComplete(){
    if(!sampler.bestItem){ setStatus('No square found'); return; }
    const { lon, lat, pop } = sampler.bestItem;
    animateSelection(lon, lat, pop);
  }

  function finishSampling(){
    clearTimeout(watchdog);
    if(usingSample){
      SAMPLE.forEach(considerRow);
      onComplete();
    }else{
      onComplete();
    }
  }

  if(usingSample){
    finishSampling();
    return;
  }

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    dynamicTyping: false,
    skipEmptyLines: 'greedy',
    delimiter: "",
    worker: false,
    step: function(row){
      processed++;
      considerRow(row.data);
      if(processed % 50000 === 0){ setStatus(`Sampling… ${processed.toLocaleString('en')}`); }
    },
    complete: function(){ finishSampling(); },
    error: function(err){
      console.error(err);
      setStatus('Using demo data');
      usingSample = true;
      finishSampling();
    }
  });
}

function clearSelection(){
  if(maskLayer){ map.removeLayer(maskLayer); maskLayer = null; }
  if(squareDashLayer){ map.removeLayer(squareDashLayer); squareDashLayer = null; }
  if(squareBorderLayer){ map.removeLayer(squareBorderLayer); squareBorderLayer = null; }
  if(popLabelMarker){ map.removeLayer(popLabelMarker); popLabelMarker = null; }
}

function animateSelection(lon, lat, pop){
  setStatus('Selected');
  const dest = L.latLng(lat, lon);
  map.flyTo(dest, 8.5, { duration: 1.0 });

  setTimeout(() => {
    // Build square polygon
    const squarePoly = buildSquarePolygon(lon, lat);
    const squareCoords = squarePoly.geometry.coordinates[0]; // [ [lon,lat], ... ]
    const squareLatLngs = squareCoords.map(([x,y]) => L.latLng(y, x));

    // Mask outside area
    const outer = [ L.latLng(85, -179.9), L.latLng(85, 179.9), L.latLng(-85, 179.9), L.latLng(-85, -179.9) ];
    maskLayer = L.polygon([outer, squareLatLngs], {
      pane: maskPaneName, stroke: false, fill: true, fillColor: '#000000', fillOpacity: 0.45
    }).addTo(map);

    // Dashed outline
    squareDashLayer = L.polygon(squareLatLngs, {
      pane: maskPaneName, color: '#ffffff', weight: 2, opacity: 0.9, dashArray: '8 6', fill: false
    }).addTo(map);

    // Solid border (this defines the brand color for the label)
    squareBorderLayer = L.polygon(squareLatLngs, {
      pane: maskPaneName, color: getComputedStyle(document.documentElement).getPropertyValue('--square-color').trim() || '#1b271a',
      weight: 2, opacity: 1, fill: false
    }).addTo(map);

    // Zoom to bounds
    const b = L.polygon(squareLatLngs).getBounds();
    map.flyToBounds(b, { padding: [40, 40], duration: 1.2 });

    // ---- Clean population label at bottom-left of square ----
    // pick bottom-left vertex (min lat+lng) and inset slightly NE to sit inside the square
    const bl = squareLatLngs.reduce((a,b)=> (b.lat + b.lng < a.lat + a.lng ? b : a));
    const inset = turf.destination([bl.lng, bl.lat], 0.12, 45, {units:'kilometers'}).geometry.coordinates; // ~120m inward
    const labelHtml = `<div class="pop-label">${Math.round(pop).toLocaleString('en')}</div>`;
    popLabelMarker = L.marker([inset[1], inset[0]], {
      icon: L.divIcon({ html: labelHtml, className: '', iconSize: [1,1], iconAnchor: [0,0] })
    }).addTo(map);

    setStatus('OK');
  }, 700);
}

// UI
window.addEventListener('DOMContentLoaded', () => {
  initMap();
  document.getElementById('pickBtn').addEventListener('click', () => { usingSample = false; pickRandomSquare(); });
  document.getElementById('resetBtn').addEventListener('click', () => {
    clearSelection();
    map.flyToBounds(FR_BOUNDS, { paddingTopLeft:[20,60], paddingBottomRight:[20,120], duration:1.0 });
    setStatus('OK');
  });
});
</script>

</body>
</html>
